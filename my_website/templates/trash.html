<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ç»ªåƒåœ¾æ¡¶ - æˆ‘çš„å°ç«™</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="/">é¦–é¡µ</a>
            <a href="/post">å‘å¸ƒæ—¥å¿—</a>
            <a href="/trash">æƒ…ç»ªåƒåœ¾æ¡¶</a>
            <a href="/admin">åå°ç®¡ç†</a>
            <span style="color: #ff99cc; margin-left: 20px;">æ¬¢è¿ï¼Œ{{ username }}</span>
            <a href="/logout" style="color: #ff6b6b; margin-left: 10px;">é€€å‡º</a>
        </div>
    </nav>

    <div class="container">
        <h1 style="text-align: center; margin: 20px 0; color: #a8d8ff; text-shadow: 0 0 10px #a8d8ff;">æƒ…ç»ªåƒåœ¾æ¡¶ ğŸ—‘ï¸</h1>
        <div class="card">
            <p style="color: #ccc;">æŠŠä¸å¼€å¿ƒçš„è¯/äº‹æ‰”è¿›æ¥å§ï¼Œä»…ä½ å¯è§ï½</p>
            
            <!-- å½©è›‹ï¼šå°è¡Œæ˜ŸéªŒè¯ç  -->
            <div class="form-group">
                <label>å°è¡Œæ˜ŸéªŒè¯ç ï¼ˆè¾“å…¥ä¸‹æ–¹æ•°å­—ï¼‰ï¼š<span id="true_verify_code" style="color: #ff99cc;">{{ verify_code }}</span></label>
                <input type="text" id="verify_code" placeholder="è¾“å…¥éªŒè¯ç ">
            </div>

            <!-- å…³é”®ï¼šä¿ç•™onsubmit="return false;"ï¼Œç¡®ä¿IDæ­£ç¡® -->
            <form id="trash_form" method="POST" enctype="multipart/form-data" onsubmit="return false;">
                <div class="form-group">
                    <label>è¦æ‰”æ‰çš„â€œåƒåœ¾â€</label>
                    <textarea id="trash_content" name="trash_content" required></textarea>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                    <!-- å…³é”®ï¼šIDå¿…é¡»æ˜¯trash_imgï¼Œå’ŒJSå¯¹åº” -->
                    <input type="file" id="trash_img" name="trash_img" accept="image/*">
                </div>
                <div class="form-group">
                    <!-- å…³é”®ï¼šIDå¿…é¡»æ˜¯anonymousï¼Œå’ŒJSå¯¹åº” -->
                    <label>
                        <input type="checkbox" id="anonymous" name="anonymous" checked> åŒ¿åæäº¤
                    </label>
                </div>
                <!-- åŠ¨ç”»å®¹å™¨ï¼šIDå¿…é¡»æ­£ç¡® -->
                <div class="trash-container">
                    <div id="trash-content" style="display: none;"></div>
                    <div id="trash-can">ğŸ—‘ï¸</div>
                </div>
                <!-- å…³é”®ï¼šæŒ‰é’®IDå¿…é¡»æ˜¯submit_trash_btnï¼Œä¸”ç»‘å®šonclickäº‹ä»¶ï¼ˆå…œåº•ï¼‰ -->
                <button type="button" id="submit_trash_btn" onclick="submitTrash()">æ‰”è¿›åƒåœ¾æ¡¶</button>
            </form>
        </div>
    </div>

    <!-- å…³é”®ï¼šJSç§»åˆ°é¡µé¢åº•éƒ¨ï¼Œç¡®ä¿DOMåŠ è½½å®Œæˆåæ‰§è¡Œ -->
    <script>
        // æƒ…ç»ªåƒåœ¾æ¡¶æäº¤åŠ¨ç”» + å¼‚æ­¥æäº¤æ•°æ®
        function submitTrash() {
            // 1. å¼ºåˆ¶æ‰“å°æ—¥å¿—ï¼Œæ’æŸ¥æ˜¯å¦è¿›å…¥å‡½æ•°
            console.log("ç‚¹å‡»äº†æŒ‰é’®ï¼å¼€å§‹æ‰§è¡Œæäº¤é€»è¾‘");

            // 2. è·å–æ‰€æœ‰DOMå…ƒç´ ï¼ˆåŠ å®¹é”™ï¼‰
            const inputCode = document.getElementById('verify_code')?.value || '';
            const trueCode = document.getElementById('true_verify_code')?.innerText || '';
            const content = document.getElementById('trash_content')?.value || '';
            const trashImg = document.getElementById('trash_img');
            const isAnonymous = document.getElementById('anonymous')?.checked || true;
            const trashContent = document.getElementById('trash-content');
            const trashCan = document.getElementById('trash-can');

            // 3. æ ¡éªŒå…ƒç´ æ˜¯å¦è·å–åˆ°
            if (!trashContent || !trashCan) {
                alert('é¡µé¢å…ƒç´ åŠ è½½å¤±è´¥ï¼åˆ·æ–°é‡è¯•');
                return;
            }

            // 4. éªŒè¯éªŒè¯ç 
            if (inputCode !== trueCode) {
                alert('éªŒè¯ç é”™è¯¯ï½å°è¡Œæ˜Ÿæ²¡è¿›è½¨é“å“¦ï¼');
                return;
            }

            // 5. éªŒè¯å†…å®¹
            if (!content) {
                alert('è¯·è¾“å…¥è¦æ‰”æ‰çš„â€œåƒåœ¾â€ï½');
                return;
            }

            // éšæœºæš–å¿ƒå›å¤
            const warmReplies = [
                "åƒåœ¾å·²ç»æ‰”æ‰å•¦ï½âœ¨ åå¿ƒæƒ…ä¹Ÿä¸€èµ·é£èµ°äº†",
                "åƒåœ¾æ¡¶å·²æ”¶åˆ°ä½ çš„çƒ¦æ¼ï¼Œç°åœ¨æ¸…ç©ºå•¦ğŸ˜˜",
                "ä¸å¼€å¿ƒçš„äº‹éƒ½ä¸¢è¿›é»‘æ´å•¦ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯å¿«ä¹ï½",
                "çƒ¦æ¼å›æ”¶æˆåŠŸï¼å¥–åŠ±è‡ªå·±ä¸€ä¸ªç”œç”œçš„å¾®ç¬‘ğŸ˜Š",
                "æƒ…ç»ªåƒåœ¾å·²å¤„ç†ï¼Œä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡å“¦ğŸ’ª"
            ];
            const randomReply = warmReplies[Math.floor(Math.random() * warmReplies.length)];

            // è®¾ç½®åŠ¨ç”»å†…å®¹
            trashContent.innerText = content;
            trashContent.style.display = 'block';

            // åŠ¨ç”»é€»è¾‘
            let x = trashContent.offsetLeft;
            let y = trashContent.offsetTop;
            const targetX = trashCan.offsetLeft + trashCan.offsetWidth/2 - trashContent.offsetWidth/2;
            const targetY = trashCan.offsetTop - trashContent.offsetHeight;

            const timer = setInterval(() => {
                x += (targetX - x) / 10;
                y += (targetY - y) / 10;
                trashContent.style.left = x + 'px';
                trashContent.style.top = y + 'px';
                trashContent.style.opacity = parseFloat(trashContent.style.opacity || 1) - 0.05;
                trashContent.style.transform = `scale(${parseFloat(trashContent.style.transform?.replace('scale(', '') || 1) - 0.05})`;

                if (Math.abs(x - targetX) < 5 && Math.abs(y - targetY) < 5) {
                    clearInterval(timer);
                    trashContent.style.display = 'none';
                    // åƒåœ¾æ¡¶æ™ƒåŠ¨
                    trashCan.style.transform = 'rotate(5deg)';
                    setTimeout(() => {
                        trashCan.style.transform = 'rotate(-5deg)';
                        setTimeout(() => {
                            trashCan.style.transform = 'rotate(0)';
                            // å¼‚æ­¥æäº¤æ•°æ®
                            submitTrashData(content, trashImg, isAnonymous, randomReply);
                            // é‡ç½®è¡¨å•
                            document.getElementById('trash_form').reset();
                        }, 100);
                    }, 100);
                }
            }, 30);
        }

        // å¼‚æ­¥æäº¤æ•°æ®
        function submitTrashData(content, imgFile, isAnonymous, reply) {
            const formData = new FormData();
            formData.append('trash_content', content);
            formData.append('anonymous', isAnonymous);
            if (imgFile && imgFile.files && imgFile.files.length > 0) {
                formData.append('trash_img', imgFile.files[0]);
            }

            // å‘é€AJAX
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/trash', true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    if (confirm(`${reply}\n\nç‚¹å‡»â€œç¡®å®šâ€è¿”å›é¦–é¡µï½`)) {
                        window.location.href = '/';
                    }
                } else {
                    alert('æäº¤å¤±è´¥å•¦ğŸ˜¥ï¼Œå†è¯•ä¸€æ¬¡å§ï¼');
                }
            };
            xhr.onerror = function() {
                alert('ç½‘ç»œå‡ºé”™äº†ï½æ£€æŸ¥ä¸€ä¸‹å†è¯•å§ï¼');
            };
            xhr.send(formData);
        }
    </script>
</body>
</html>